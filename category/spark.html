<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>Spark  -guozhongxin's blog</title>
    <meta name="description" content="">
    <meta name="author" content="guozhongxin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://www.guozhongxin.com/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://www.guozhongxin.com/theme/bootstrap.min.css" rel="stylesheet">
    <link href="http://www.guozhongxin.com/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="http://www.guozhongxin.com/theme/local.css" rel="stylesheet">
    <link href="http://www.guozhongxin.com/theme/pygments.css" rel="stylesheet">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="http://www.guozhongxin.com">guozhongxin's blog</a>

        <div class="nav-collapse">
        <ul class="nav">
            
            <li><a href="http://www.guozhongxin.com/pages/about-me.html">About Me</a></li>
        </ul>
        <div class="navbar-search pull-right">
            <script type="text/javascript">document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E%3Cscript charset="utf-8" src="http://rp.baidu.com/rp3w/3w.js?sid=6131086231916765095') + '&t=' + (Math.ceil(new Date()/3600000)) + unescape('"%3E%3C/script%3E'));</script>
        </div>
        </div>

    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="http://www.guozhongxin.com/pages/2015/01/25/spark_dagscheduler.html"><h1>Spark DAGScheduler模块源码解析</h1></a>
2015-01-25

by <a class="url fn" href="http://www.guozhongxin.com/author/guozhongxin.html">guozhongxin</a>
 


 
        </div>
        
        <div><h2>Spark DAGScheduler的背景知识</h2>
<p>Spark Application在遇到action算子时，SparkContext会生成Job，并将构成DAG图将给DAG Scheduler解析成Stage。</p>
<h3>Stage</h3>
<p>Stage是Spark对DAG的划分，以此作为对作业的进行任务（task）划分和调度的依据。<br />
可以这样理解Stage不需要shuffle是可以随意并发的, 所以stage的边界就是需要shuffle的地方。</p>
<p>下图是一个stage例子。
<img alt="3" src="http://www.guozhongxin.com/images/stage.png" /> </p>
<p>Stage有两种： </p>
<ul>
<li>ShuffleMapStage<br />
  这种Stage是以Shuffle为输出边界，其输入边界可以是从外部获取数据，也可以是另一个ShuffleMapStage的输出，其输出可以。是另一个Stage的开始ShuffleMapStage的最后Task就是ShuffleMapTask。在一个Job里可能有该类型的Stage，也可以能没有该类型Stage。<br />
  上图Stage 1，Stage 2都属于ShuffleMapStage</li>
<li>ResultStage<br />
  这种Stage是直接输出结果。其输入边界可以是从外部获取数据，也可以是另一个ShuffleMapStage的输出。ResultStage的最后Task就是ResultTask。在一个Job里必定有该类型Stage。一个Job含有一个或多个Stage，但至少含有一个ResultStage。</li>
</ul>
<h3>DAGScheduler</h3>
<p>DAGScheduler主要功能如下：  </p>
<ul>
<li>接收用户提交的job;</li>
<li>将job根据类型划分为不同的stage，记录哪些RDD、Stage被物化，并在每一个stage内产生一系列的task，并封装成TaskSet；</li>
<li>决定每个Task的最佳位置(任务在数据所在的节点上运行)，并结合当前的缓存情况；将TaskSet提交给TaskScheduler;</li>
<li>重新提交Shuffle输出丢失的Stage给TaskScheduler；</li>
</ul>
<p>注：一个Stage内部的错误不是由shuffle输出丢失造成的，DAGScheduler是不管的，由TaskScheduler负责尝试重新提交task执行；</p>
<h2>Spark DAGScheduler源码解析</h2>
<p>DAGScheduler的创建是在用户定义一个新的<code>SparkContext</code>时进行的。（需要注意的是，在SparkContext中，TaskSchduler是在DAGScheduler之前生成的，即<code>dagScheduler = new DAGScheduler(this)</code>中的this.taskScheduler已经被生成，这个taskScheduler也是dagScheduler的一个成员变量）</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">1&nbsp;</span><span style="color: rgb(220, 220, 204);">@volatile</span> <span style="color: rgb(227, 206, 171);">private</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">spark</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">var</span> <span style="color: rgb(220, 220, 204);">dagScheduler</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">DAGScheduler</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(227, 206, 171);">_</span><br><span style="color: rgb(127, 159, 127);">2&nbsp;</span><span style="color: rgb(227, 206, 171);">try</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">3&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">dagScheduler</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">DAGScheduler</span>(<span style="color: rgb(227, 206, 171);">this</span>)<br><span style="color: rgb(127, 159, 127);">4&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">catch</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">5&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">e</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Exception</span> <span style="color: rgb(220, 220, 204);">=&gt;</span> <span style="color: rgb(227, 206, 171);">throw</span><br><span style="color: rgb(127, 159, 127);">6&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">SparkException</span>(<span style="color: rgb(204, 147, 147);">&quot;DAGScheduler cannot be initialized due to %s&quot;</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">format</span>(<span style="color: rgb(220, 220, 204);">e</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">getMessage</span>))<br><span style="color: rgb(127, 159, 127);">7&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>当执行<code>输出算子</code>的时候，spark会调用<code>sc.runJob()</code>方法，例如<code>RDD.scala</code>中定义的<code>count()</code>:  </p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">1&nbsp;</span><span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">count</span>()<span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Long</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(220, 220, 204);">sc</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">runJob</span>(<span style="color: rgb(227, 206, 171);">this</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">Utils</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">getIteratorSize</span> <span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">).</span><span style="color: rgb(220, 220, 204);">sum</span><br></div>

<hr />
<p>跟进到<code>SparkContext.scala</code>中的<code>runJob()</code>方法，可以看到：  </p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">runJob</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span>, <span style="color: rgb(223, 223, 191); font-weight: bold;">U:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">ClassTag</span><span style="color: rgb(220, 220, 204);">](</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(227, 206, 171);">:</span> (<span style="color: rgb(223, 223, 191); font-weight: bold;">TaskContext</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Iterator</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span><span style="color: rgb(220, 220, 204);">])</span> <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">U</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Seq</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Boolean</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">06&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">resultHandler</span><span style="color: rgb(227, 206, 171);">:</span> (<span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">U</span>) <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">Unit</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(204, 120, 51);">dagScheduler</span> <span style="color: rgb(220, 220, 204);">==</span> <span style="color: rgb(227, 206, 171);">null</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">08&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">throw</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">SparkException</span>(<span style="color: rgb(204, 147, 147);">&quot;SparkContext has been shutdown&quot;</span>)<br><span style="color: rgb(127, 159, 127);">09&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">callSite</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">getCallSite</span><br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">cleanedFunc</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">clean</span>(<span style="color: rgb(220, 220, 204);">func</span>)<br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Starting job: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">shortForm</span>)<br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">start</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">System</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">nanoTime</span><br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp;<span style="color: rgb(204, 120, 51);">dagScheduler</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">runJob</span>(<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">cleanedFunc</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">resultHandler</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">localProperties</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">get</span>)<br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(204, 147, 147);">&quot;Job finished: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">shortForm</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;, took &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> (<span style="color: rgb(220, 220, 204);">System</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">nanoTime</span> <span style="color: rgb(220, 220, 204);">-</span> <span style="color: rgb(220, 220, 204);">start</span>) <span style="color: rgb(220, 220, 204);">/</span> <span style="color: rgb(140, 208, 211);">1</span><span style="color: rgb(220, 220, 204);">e9</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot; s&quot;</span>)<br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">doCheckpoint</span>()<br><span style="color: rgb(127, 159, 127);">19&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p><code>sc.runJob()</code>是调用的<code>dagScheduler.runJob()</code>方法。跟进到<code>DAGScheduler.runJob()</code></p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">runJob</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span>, <span style="color: rgb(223, 223, 191); font-weight: bold;">U:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">ClassTag</span><span style="color: rgb(220, 220, 204);">](</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(227, 206, 171);">:</span> (<span style="color: rgb(223, 223, 191); font-weight: bold;">TaskContext</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Iterator</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">T</span><span style="color: rgb(220, 220, 204);">])</span> <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">U</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Seq</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">CallSite</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">06&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Boolean</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">resultHandler</span><span style="color: rgb(227, 206, 171);">:</span> (<span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">U</span>) <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">Unit</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">08&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">properties</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Properties</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(227, 206, 171);">null</span>)<br><span style="color: rgb(127, 159, 127);">09&nbsp;</span><span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">start</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">System</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">nanoTime</span><br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">waiter</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(204, 120, 51);">submitJob</span>(<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">resultHandler</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>)<br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">waiter</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">awaitResult</span>() <span style="color: rgb(227, 206, 171);">match</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">JobSucceeded</span> <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Job %d finished: %s, took %f s&quot;</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">format</span><br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;(<span style="color: rgb(220, 220, 204);">waiter</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">shortForm</span><span style="color: rgb(220, 220, 204);">,</span> (<span style="color: rgb(220, 220, 204);">System</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">nanoTime</span> <span style="color: rgb(220, 220, 204);">-</span> <span style="color: rgb(220, 220, 204);">start</span>) <span style="color: rgb(220, 220, 204);">/</span> <span style="color: rgb(140, 208, 211);">1</span><span style="color: rgb(220, 220, 204);">e9</span>))<br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">JobFailed</span>(<span style="color: rgb(220, 220, 204);">exception</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Exception</span>) <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Job %d failed: %s, took %f s&quot;</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">format</span><br><span style="color: rgb(127, 159, 127);">19&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;(<span style="color: rgb(220, 220, 204);">waiter</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">shortForm</span><span style="color: rgb(220, 220, 204);">,</span> (<span style="color: rgb(220, 220, 204);">System</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">nanoTime</span> <span style="color: rgb(220, 220, 204);">-</span> <span style="color: rgb(220, 220, 204);">start</span>) <span style="color: rgb(220, 220, 204);">/</span> <span style="color: rgb(140, 208, 211);">1</span><span style="color: rgb(220, 220, 204);">e9</span>))<br><span style="color: rgb(248, 16, 176);">20&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">throw</span> <span style="color: rgb(220, 220, 204);">exception</span><br><span style="color: rgb(127, 159, 127);">21&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">22&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>当job被正常提交时，<code>submitJob()</code>返回一个<code>JobWaiter</code>的类，并产生一个<strong><code>JobSubmitted</code></strong>的<code>event</code>（事件）</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">1&nbsp;</span><span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">waiter</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">JobWaiter</span>(<span style="color: rgb(227, 206, 171);">this</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">size</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">resultHandler</span>)<br><span style="color: rgb(127, 159, 127);">2&nbsp;</span><span style="color: rgb(220, 220, 204);">eventProcessActor</span> <span style="color: rgb(220, 220, 204);">!</span> <span style="color: rgb(204, 120, 51);">JobSubmitted</span>(<br><span style="color: rgb(127, 159, 127);">3&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">func2</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">toArray</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">waiter</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>)<br><span style="color: rgb(127, 159, 127);">4&nbsp;</span><span style="color: rgb(220, 220, 204);">waiter</span><br></div>

<hr />
<p>DAGScheduler是一个<strong>生产者-消费者模型</strong>。在DAGScheduler的实例<code>dagScheduler</code>在SparkContext中被创建时，<code>dagScheduler</code>初始化了一个守候进程，用来对DAGScheduler中的各种事件进行相应。</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">1&nbsp;</span><span style="color: rgb(227, 206, 171);">private</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">initializeEventProcessActor</span>() <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">2&nbsp;</span> &nbsp;<span style="color: rgb(127, 159, 127);">// blocking the thread until supervisor is started, which ensures eventProcessActor is</span><br><span style="color: rgb(127, 159, 127);">3&nbsp;</span> &nbsp;<span style="color: rgb(127, 159, 127);">// not null before any job is submitted</span><br><span style="color: rgb(127, 159, 127);">4&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">implicit</span> <span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">timeout</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">Timeout</span>(<span style="color: rgb(140, 208, 211);">30</span> <span style="color: rgb(220, 220, 204);">seconds</span>)<br><span style="color: rgb(248, 16, 176);">5&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">initEventActorReply</span> <span style="color: rgb(227, 206, 171);">=</span><br><span style="color: rgb(127, 159, 127);">6&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">dagSchedulerActorSupervisor</span> <span style="color: rgb(220, 220, 204);">?</span> <span style="color: rgb(220, 220, 204);">Props</span>(<span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(204, 120, 51);">DAGSchedulerEventProcessActor</span>(<span style="color: rgb(227, 206, 171);">this</span>))<br><span style="color: rgb(127, 159, 127);">7&nbsp;</span> &nbsp;<span style="color: rgb(204, 120, 51);">eventProcessActor</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">Await</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">result</span>(<span style="color: rgb(220, 220, 204);">initEventActorReply</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">timeout</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">duration</span><span style="color: rgb(220, 220, 204);">).</span><br><span style="color: rgb(127, 159, 127);">8&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">asInstanceOf</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">ActorRef</span><span style="color: rgb(220, 220, 204);">]</span><br><span style="color: rgb(127, 159, 127);">9&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p><code>DAGSchedulerEventProcessActor</code>这个class在DAGScheduler.scala中被定义，用来接受并处理DAGScheduler工作时产生的各种事件<code>event</code>,处理的方法是调用传入的<code>dagScheduler</code>中的方法。<code>DAGSchedulerEventProcessActor</code>处理的事件有：</p>
<ul>
<li>JobSubmitted</li>
<li>StageCancelled</li>
<li>JobCancelled</li>
<li>JobGroupCancelled</li>
<li>AllJobsCancelled</li>
<li>ExecutorAdded</li>
<li>ExecutorLost</li>
<li>BeginEvent</li>
<li>GettingResultEvent</li>
<li>CompletionEvent</li>
<li>ResubmitFailedStages</li>
</ul>
<p>以<code>JobSubmitted</code>事件为例：</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">1&nbsp;</span><span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">JobSubmitted</span>(<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">listener</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>) <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">2&nbsp;</span> &nbsp;<span style="color: rgb(204, 120, 51);">dagScheduler</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">handleJobSubmitted</span>(<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">3&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listener</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>)<br></div>

<hr />
<p><code>dagScheduler.handleJobSubmitted</code>将接收到finalRDD的依赖关系解析出来，生成stages，即整个DAG的结构，再调用函数将stage内的tasks打包成TaskSet,交给taskScheduler处理。跟着这个方法，<code>handleJobSubmitted</code>，就可以了解DAGScheduler的主要功能和实现原理。</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(227, 206, 171);">private</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">scheduler</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">handleJobSubmitted</span>(<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">finalRDD</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(227, 206, 171);">:</span> (<span style="color: rgb(223, 223, 191); font-weight: bold;">TaskContext</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Iterator</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">])</span> <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Array</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span><span style="color: rgb(220, 220, 204);">],</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">allowLocal</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Boolean</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">06&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">CallSite</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listener</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">JobListener</span><span style="color: rgb(220, 220, 204);">,</span><br><span style="color: rgb(127, 159, 127);">08&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">properties</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Properties</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(227, 206, 171);">null</span>)<br><span style="color: rgb(127, 159, 127);">09&nbsp;</span><span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">var</span> <span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(227, 206, 171);">null</span><br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">try</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// New stage creation may throw an exception if, for example, jobs are run on a</span><br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// HadoopRDD whose underlying HDFS files have been deleted.</span><br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">finalStage</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">newStage</span>(<span style="color: rgb(220, 220, 204);">finalRDD</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">size</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">None</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span>)<br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">catch</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">e</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Exception</span> <span style="color: rgb(220, 220, 204);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logWarning</span>(<span style="color: rgb(204, 147, 147);">&quot;Creating new stage failed due to exception - job: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">e</span>)<br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listener</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobFailed</span>(<span style="color: rgb(220, 220, 204);">e</span>)<br><span style="color: rgb(127, 159, 127);">19&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">return</span><br><span style="color: rgb(248, 16, 176);">20&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">21&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">finalStage</span> <span style="color: rgb(220, 220, 204);">!=</span> <span style="color: rgb(227, 206, 171);">null</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">22&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">job</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">ActiveJob</span>(<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">func</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">listener</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>)<br><span style="color: rgb(127, 159, 127);">23&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">clearCacheLocs</span>()<br><span style="color: rgb(127, 159, 127);">24&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Got job %s (%s) with %d output partitions (allowLocal=%s)&quot;</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">format</span>(<br><span style="color: rgb(248, 16, 176);">25&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">job</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">callSite</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">shortForm</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">length</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">allowLocal</span>))<br><span style="color: rgb(127, 159, 127);">26&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Final stage: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">finalStage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;(&quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">name</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;)&quot;</span>)<br><span style="color: rgb(127, 159, 127);">27&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Parents of final stage: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">parents</span>)<br><span style="color: rgb(127, 159, 127);">28&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Missing parents: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">getMissingParentStages</span>(<span style="color: rgb(220, 220, 204);">finalStage</span>))<br><span style="color: rgb(127, 159, 127);">29&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">shouldRunLocally</span> <span style="color: rgb(227, 206, 171);">=</span><br><span style="color: rgb(248, 16, 176);">30&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">localExecutionEnabled</span> <span style="color: rgb(220, 220, 204);">&amp;&amp;</span> <span style="color: rgb(220, 220, 204);">allowLocal</span> <span style="color: rgb(220, 220, 204);">&amp;&amp;</span> <span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">parents</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isEmpty</span> <span style="color: rgb(220, 220, 204);">&amp;&amp;</span> <span style="color: rgb(220, 220, 204);">partitions</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">length</span> <span style="color: rgb(220, 220, 204);">==</span> <span style="color: rgb(140, 208, 211);">1</span><br><span style="color: rgb(127, 159, 127);">31&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">shouldRunLocally</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">32&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// Compute very short actions like first() or take() with no parent stages locally.</span><br><span style="color: rgb(127, 159, 127);">33&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listenerBus</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">post</span>(<span style="color: rgb(220, 220, 204);">SparkListenerJobStart</span>(<span style="color: rgb(220, 220, 204);">job</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">Seq</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">empty</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>))<br><span style="color: rgb(127, 159, 127);">34&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">runLocally</span>(<span style="color: rgb(220, 220, 204);">job</span>)<br><span style="color: rgb(248, 16, 176);">35&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">else</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">36&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">jobIdToActiveJob</span>(<span style="color: rgb(220, 220, 204);">jobId</span>) <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">job</span><br><span style="color: rgb(127, 159, 127);">37&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">activeJobs</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">job</span><br><span style="color: rgb(127, 159, 127);">38&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">finalStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">resultOfJob</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">Some</span>(<span style="color: rgb(220, 220, 204);">job</span>)<br><span style="color: rgb(127, 159, 127);">39&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">stageIds</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">jobIdToStageIds</span>(<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">).</span><span style="color: rgb(220, 220, 204);">toArray</span><br><span style="color: rgb(248, 16, 176);">40&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">stageInfos</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">stageIds</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">flatMap</span>(<span style="color: rgb(220, 220, 204);">id</span> <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(220, 220, 204);">stageIdToStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">get</span>(<span style="color: rgb(220, 220, 204);">id</span><span style="color: rgb(220, 220, 204);">).</span><span style="color: rgb(220, 220, 204);">map</span>(<span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">latestInfo</span>))<br><span style="color: rgb(127, 159, 127);">41&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listenerBus</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">post</span>(<span style="color: rgb(220, 220, 204);">SparkListenerJobStart</span>(<span style="color: rgb(220, 220, 204);">job</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stageInfos</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>))<br><span style="color: rgb(127, 159, 127);">42&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">submitStage</span>(<span style="color: rgb(220, 220, 204);">finalStage</span>)<br><span style="color: rgb(127, 159, 127);">43&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">44&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(248, 16, 176);">45&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">submitWaitingStages</span>()<br><span style="color: rgb(127, 159, 127);">46&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>可以看出，DAGScheduler生成stage，是通过最后一个RDD推算出来的，（这个RDD通过<code>sc.runJob()</code> -&gt; <code>dagScheduler.runJob()</code> -&gt; <code>dagScheduler.submitJob()</code> -&gt; <code>JobSubmitted()</code> -&gt; <code>dagScheduler.handleJobSubmitted()</code> 层层调用传进来的）</p>
<p>这一行代码，</p>
<div class="highlight"><pre>finalStage = newStage(finalRDD, partitions.size, None, jobId, callSite)
</pre></div>


<p>通过调用<code>newStage()</code>方法，生成了<strong>finalStage</strong>。实际上，<code>newStage()</code>中调用了<code>getParentStages()</code>方法，由finalRDD向前追溯，生成了parentStages。</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(227, 206, 171);">private</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">getParentStages</span>(<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">],</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span>)<span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">List</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">parents</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">HashSet</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span><span style="color: rgb(220, 220, 204);">]</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">visited</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">HashSet</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]]</span><br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp;<span style="color: rgb(127, 159, 127);">// We are manually maintaining a stack here to prevent StackOverflowError</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp;<span style="color: rgb(127, 159, 127);">// caused by recursively visiting</span><br><span style="color: rgb(127, 159, 127);">06&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">waitingForVisit</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">Stack</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]]</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">visit</span>(<span style="color: rgb(220, 220, 204);">r</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">])</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">08&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">visited</span>(<span style="color: rgb(220, 220, 204);">r</span>)) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">09&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">visited</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">r</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// Kind of ugly: need to register RDDs with the cache here since</span><br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// we can&#39;t do it in its constructor because # of partitions is unknown</span><br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">for</span> (<span style="color: rgb(220, 220, 204);">dep</span> <span style="color: rgb(227, 206, 171);">&lt;-</span> <span style="color: rgb(220, 220, 204);">r</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">dependencies</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">dep</span> <span style="color: rgb(227, 206, 171);">match</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">shufDep</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">ShuffleDependency</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span>, <span style="color: rgb(227, 206, 171);">_</span>, <span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">parents</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">getShuffleMapStage</span>(<span style="color: rgb(220, 220, 204);">shufDep</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">jobId</span>)<br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(227, 206, 171);">_</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">push</span>(<span style="color: rgb(220, 220, 204);">dep</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span>)<br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">19&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(248, 16, 176);">20&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">21&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">22&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">push</span>(<span style="color: rgb(220, 220, 204);">rdd</span>)<br><span style="color: rgb(127, 159, 127);">23&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">while</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isEmpty</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">24&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">visit</span>(<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">pop</span>())<br><span style="color: rgb(248, 16, 176);">25&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">26&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">parents</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">toList</span><br><span style="color: rgb(127, 159, 127);">27&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>回到<code>handleJobSubmitted()</code>,看到27、28两行，一个是<em>"Parents of final stage: "</em>，这个是由<strong>getParentStages（）</strong>方法获取的，而<em>"Missing parents: "</em>，是由<strong>getMissingParentStages</strong>获取的，在这里(handleJobSubmitted()),两者没有什么不同。但是在其他地方，调用两个函数还是会有不同效果。</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01 </span><span style="color: rgb(227, 206, 171);">private</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">getMissingParentStages</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span>)<span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">List</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">02 </span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">missing</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">HashSet</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span><span style="color: rgb(220, 220, 204);">]</span><br><span style="color: rgb(127, 159, 127);">03 </span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">visited</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">HashSet</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]]</span><br><span style="color: rgb(127, 159, 127);">04 </span> &nbsp;<span style="color: rgb(127, 159, 127);">// We are manually maintaining a stack here to prevent StackOverflowError</span><br><span style="color: rgb(248, 16, 176);">05 </span> &nbsp;<span style="color: rgb(127, 159, 127);">// caused by recursively visiting</span><br><span style="color: rgb(127, 159, 127);">06 </span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">waitingForVisit</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">Stack</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]]</span><br><span style="color: rgb(127, 159, 127);">07 </span> &nbsp;<span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">visit</span>(<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">RDD</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">])</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">08 </span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">visited</span>(<span style="color: rgb(220, 220, 204);">rdd</span>)) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">09 </span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">visited</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">rdd</span><br><span style="color: rgb(248, 16, 176);">10 </span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">getCacheLocs</span>(<span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">).</span><span style="color: rgb(220, 220, 204);">contains</span>(<span style="color: rgb(220, 220, 204);">Nil</span>)) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">11 </span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">for</span> (<span style="color: rgb(220, 220, 204);">dep</span> <span style="color: rgb(227, 206, 171);">&lt;-</span> <span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">dependencies</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">12 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">dep</span> <span style="color: rgb(227, 206, 171);">match</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">13 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">shufDep</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">ShuffleDependency</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span>, <span style="color: rgb(227, 206, 171);">_</span>, <span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">14 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">mapStage</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">getShuffleMapStage</span>(<span style="color: rgb(220, 220, 204);">shufDep</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span>)<br><span style="color: rgb(248, 16, 176);">15 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">mapStage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isAvailable</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">16 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">missing</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">mapStage</span><br><span style="color: rgb(127, 159, 127);">17 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">18 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">narrowDep</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">NarrowDependency</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">19 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">push</span>(<span style="color: rgb(220, 220, 204);">narrowDep</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span>)<br><span style="color: rgb(248, 16, 176);">20 </span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">21 </span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">22 </span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">23 </span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">24 </span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(248, 16, 176);">25 </span> &nbsp;<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">push</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span>)<br><span style="color: rgb(127, 159, 127);">26 </span> &nbsp;<span style="color: rgb(227, 206, 171);">while</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isEmpty</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">27 </span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">visit</span>(<span style="color: rgb(220, 220, 204);">waitingForVisit</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">pop</span>())<br><span style="color: rgb(127, 159, 127);">28 </span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">29 </span> &nbsp;<span style="color: rgb(220, 220, 204);">missing</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">toList</span><br><span style="color: rgb(248, 16, 176);">30 </span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>由以上的代码可以看出，<code>getMissingParentStages()</code>与<code>getParentStages()</code>在第15、16行。</p>
<p>回到<code>handleJobSubmitted()</code>41、42行，DAGScheduler向监听总线发生一个JobStart的事件，之后，调用<code>submitStage()</code>将生成的Stage提交</p>
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(127, 159, 127);">/** Submits stage, but first recursively submits any missing parents. */</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span><span style="color: rgb(227, 206, 171);">private</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">submitStage</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">jobId</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">activeJobForStage</span>(<span style="color: rgb(220, 220, 204);">stage</span>)<br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isDefined</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logDebug</span>(<span style="color: rgb(204, 147, 147);">&quot;submitStage(&quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;)&quot;</span>)<br><span style="color: rgb(127, 159, 127);">06&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> <span style="color: rgb(220, 220, 204);">(!</span><span style="color: rgb(220, 220, 204);">waitingStages</span>(<span style="color: rgb(220, 220, 204);">stage</span>) <span style="color: rgb(220, 220, 204);">&amp;&amp;</span> <span style="color: rgb(220, 220, 204);">!</span><span style="color: rgb(220, 220, 204);">runningStages</span>(<span style="color: rgb(220, 220, 204);">stage</span>) <span style="color: rgb(220, 220, 204);">&amp;&amp;</span> <span style="color: rgb(220, 220, 204);">!</span><span style="color: rgb(220, 220, 204);">failedStages</span>(<span style="color: rgb(220, 220, 204);">stage</span>)) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">missing</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">getMissingParentStages</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">).</span><span style="color: rgb(220, 220, 204);">sortBy</span>(<span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">08&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logDebug</span>(<span style="color: rgb(204, 147, 147);">&quot;missing: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">missing</span>)<br><span style="color: rgb(127, 159, 127);">09&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">missing</span> <span style="color: rgb(220, 220, 204);">==</span> <span style="color: rgb(220, 220, 204);">Nil</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Submitting &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot; (&quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;), which has no missing parents&quot;</span>)<br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(204, 120, 51);">submitMissingTasks</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">get</span>)<br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">else</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">for</span> (<span style="color: rgb(220, 220, 204);">parent</span> <span style="color: rgb(227, 206, 171);">&lt;-</span> <span style="color: rgb(220, 220, 204);">missing</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">submitStage</span>(<span style="color: rgb(220, 220, 204);">parent</span>)<br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">waitingStages</span> <span style="color: rgb(220, 220, 204);">+=</span> <span style="color: rgb(220, 220, 204);">stage</span><br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">19&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">else</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">20&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">abortStage</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(204, 147, 147);">&quot;No active job for stage &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">21&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">22&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div>

<hr />
<p>在<code>submitMissingTasks()</code>中，DAGScheduler将stage中的tasks进行拆分，并将tasks打包成TaskSet，交给TaskScheduler处理。
<div class="source" style="font-family: Monaco, Consolas, 'Lucida Console', 'Courier New'; color: rgb(220, 220, 204); background-color: rgb(63, 63, 63);"><span style="color: rgb(127, 159, 127);">01&nbsp;</span><span style="color: rgb(127, 159, 127);">/*<em> Called when stage&#39;s parents are available and we can now do its task. </em>/</span><br><span style="color: rgb(127, 159, 127);">02&nbsp;</span><span style="color: rgb(227, 206, 171);">private</span> <span style="color: rgb(227, 206, 171);">def</span> <span style="color: rgb(220, 220, 204);">submitMissingTasks</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Stage</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">03&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">logDebug</span>(<span style="color: rgb(204, 147, 147);">&quot;submitMissingTasks(&quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;)&quot;</span>)<br><span style="color: rgb(127, 159, 127);">04&nbsp;</span> &nbsp;<span style="color: rgb(127, 159, 127);">// Get our pending tasks and remember them in our pendingTasks entry</span><br><span style="color: rgb(248, 16, 176);">05&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">pendingTasks</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">clear</span>()<br><span style="color: rgb(127, 159, 127);">06&nbsp;</span><br><span style="color: rgb(127, 159, 127);">07&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">····</span><br><span style="color: rgb(127, 159, 127);">08&nbsp;</span><br><span style="color: rgb(127, 159, 127);">09&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(204, 120, 51);">tasks</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Seq</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(223, 223, 191); font-weight: bold;">Task</span><span style="color: rgb(220, 220, 204);">[</span><span style="color: rgb(227, 206, 171);">_</span><span style="color: rgb(220, 220, 204);">]]</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isShuffleMap</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">10&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">partitionsToCompute</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">map</span> <span style="color: rgb(220, 220, 204);">{</span> <span style="color: rgb(220, 220, 204);">id</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">11&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">locs</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">getPreferredLocs</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">12&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">part</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">partitions</span>(<span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">13&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">ShuffleMapTask</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">id</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">taskBinary</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">part</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">locs</span>)<br><span style="color: rgb(127, 159, 127);">14&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(248, 16, 176);">15&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">else</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">16&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">job</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">resultOfJob</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">get</span><br><span style="color: rgb(127, 159, 127);">17&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">partitionsToCompute</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">map</span> <span style="color: rgb(220, 220, 204);">{</span> <span style="color: rgb(220, 220, 204);">id</span> <span style="color: rgb(227, 206, 171);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">18&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> p<span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">Int</span> <span style="color: rgb(220, 220, 204);">=</span> <span style="color: rgb(220, 220, 204);">job</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">partitions</span>(<span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">19&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">part</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">partitions</span>(p)<br><span style="color: rgb(248, 16, 176);">20&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">val</span> <span style="color: rgb(220, 220, 204);">locs</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">getPreferredLocs</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span><span style="color: rgb(220, 220, 204);">,</span> p)<br><span style="color: rgb(127, 159, 127);">21&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(220, 220, 204);">ResultTask</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">id</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">taskBinary</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">part</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">locs</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">id</span>)<br><span style="color: rgb(127, 159, 127);">22&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">23&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">24&nbsp;</span><br><span style="color: rgb(248, 16, 176);">25&nbsp;</span> &nbsp;<span style="color: rgb(227, 206, 171);">if</span> (<span style="color: rgb(220, 220, 204);">tasks</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">size</span> <span style="color: rgb(220, 220, 204);">&gt;</span> <span style="color: rgb(140, 208, 211);">0</span>) <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">26&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// Preemptively serialize a task to make sure it can be serialized. </span><br><span style="color: rgb(127, 159, 127);">27&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">try</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">28&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">closureSerializer</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">serialize</span>(<span style="color: rgb(220, 220, 204);">tasks</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">head</span>)<br><span style="color: rgb(127, 159, 127);">29&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">catch</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(248, 16, 176);">30&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">e</span><span style="color: rgb(227, 206, 171);">:</span> <span style="color: rgb(223, 223, 191); font-weight: bold;">NotSerializableException</span> <span style="color: rgb(220, 220, 204);">=&gt;</span><br><span style="color: rgb(127, 159, 127);">31&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">abortStage</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(204, 147, 147);">&quot;Task not serializable: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">e</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">toString</span>)<br><span style="color: rgb(127, 159, 127);">32&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">runningStages</span> <span style="color: rgb(220, 220, 204);">-=</span> <span style="color: rgb(220, 220, 204);">stage</span><br><span style="color: rgb(127, 159, 127);">33&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">return</span><br><span style="color: rgb(127, 159, 127);">34&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">case</span> <span style="color: rgb(220, 220, 204);">NonFatal</span>(<span style="color: rgb(220, 220, 204);">e</span>) <span style="color: rgb(227, 206, 171);">=&gt;</span> <span style="color: rgb(127, 159, 127);">// Other exceptions, such as IllegalArgumentException from Kryo.</span><br><span style="color: rgb(248, 16, 176);">35&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">abortStage</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">,</span> s<span style="color: rgb(204, 147, 147);">&quot;Task serialization failed: $e\n${e.getStackTraceString}&quot;</span>)<br><span style="color: rgb(127, 159, 127);">36&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">runningStages</span> <span style="color: rgb(220, 220, 204);">-=</span> <span style="color: rgb(220, 220, 204);">stage</span><br><span style="color: rgb(127, 159, 127);">37&nbsp;</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">return</span><br><span style="color: rgb(127, 159, 127);">38&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">39&nbsp;</span><br><span style="color: rgb(248, 16, 176);">40&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logInfo</span>(<span style="color: rgb(204, 147, 147);">&quot;Submitting &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">tasks</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">size</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot; missing tasks from &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot; (&quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">rdd</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot;)&quot;</span>)<br><span style="color: rgb(127, 159, 127);">41&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">pendingTasks</span> <span style="color: rgb(220, 220, 204);">++=</span> <span style="color: rgb(220, 220, 204);">tasks</span><br><span style="color: rgb(127, 159, 127);">42&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logDebug</span>(<span style="color: rgb(204, 147, 147);">&quot;New pending tasks: &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">pendingTasks</span>)<br><span style="color: rgb(127, 159, 127);">43&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(204, 120, 51);">taskScheduler</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">submitTasks</span>(<br><span style="color: rgb(127, 159, 127);">44&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(227, 206, 171);">new</span> <span style="color: rgb(204, 120, 51);">TaskSet</span>(<span style="color: rgb(220, 220, 204);">tasks</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">toArray</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">id</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">newAttemptId</span><span style="color: rgb(220, 220, 204);">(),</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">jobId</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">properties</span>))<br><span style="color: rgb(248, 16, 176);">45&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">latestInfo</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">submissionTime</span> <span style="color: rgb(227, 206, 171);">=</span> <span style="color: rgb(220, 220, 204);">Some</span>(<span style="color: rgb(220, 220, 204);">clock</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">getTime</span>())<br><span style="color: rgb(127, 159, 127);">46&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span> <span style="color: rgb(227, 206, 171);">else</span> <span style="color: rgb(220, 220, 204);">{</span><br><span style="color: rgb(127, 159, 127);">47&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// Because we posted SparkListenerStageSubmitted earlier, we should post</span><br><span style="color: rgb(127, 159, 127);">48&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(127, 159, 127);">// SparkListenerStageCompleted here in case there are no tasks to run.</span><br><span style="color: rgb(127, 159, 127);">49&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">listenerBus</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">post</span>(<span style="color: rgb(220, 220, 204);">SparkListenerStageCompleted</span>(<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">latestInfo</span>))<br><span style="color: rgb(248, 16, 176);">50&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">logDebug</span>(<span style="color: rgb(204, 147, 147);">&quot;Stage &quot;</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(220, 220, 204);">stage</span> <span style="color: rgb(220, 220, 204);">+</span> <span style="color: rgb(204, 147, 147);">&quot; is actually done; %b %d %d&quot;</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">format</span>(<br><span style="color: rgb(127, 159, 127);">51&nbsp;</span> &nbsp; &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">isAvailable</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">numAvailableOutputs</span><span style="color: rgb(220, 220, 204);">,</span> <span style="color: rgb(220, 220, 204);">stage</span><span style="color: rgb(220, 220, 204);">.</span><span style="color: rgb(220, 220, 204);">numPartitions</span>))<br><span style="color: rgb(127, 159, 127);">52&nbsp;</span> &nbsp; &nbsp;<span style="color: rgb(220, 220, 204);">runningStages</span> <span style="color: rgb(220, 220, 204);">-=</span> <span style="color: rgb(220, 220, 204);">stage</span><br><span style="color: rgb(127, 159, 127);">53&nbsp;</span> &nbsp;<span style="color: rgb(220, 220, 204);">}</span><br><span style="color: rgb(127, 159, 127);">54&nbsp;</span><span style="color: rgb(220, 220, 204);">}</span><br></div></p>
<hr />
<p>接下来的工作，就交给TaskScheduler解决了。</p>
<p>有时间再整理一下吧</p></div>
        <hr />
    </div>
		

 
        

 

    <div class='article'>
        <a href="http://www.guozhongxin.com/pages/2014/10/15/spark_source_code.html"><h2>Windows + IDEA + SBT 打造Spark源码阅读环境</h2></a>
        <div class= "well small"> 2014-10-15

by <a class="url fn" href="http://www.guozhongxin.com/author/guozhongxin.html">guozhongxin</a>
 


 </div>
        <div class="summary"><h2>Spark源码阅读环境的准备</h2>
<p>Spark源码是有Scala语言写成的，目前，<a href="/http://www.jetbrains.com/idea/">IDEA</a>对Scala的支持要比eclipse要好，大多数人会选在在IDEA上完成Spark平台应用的开发。因此，Spark源码阅读的IDE理所当然的选择了IDEA。</p>
<p>本文介绍的是Windows下的各项配置方法（默认已经装了java，JDK）。</p>
<p>下面列举搭建此环境需要的各个组件：</p>
<ul>
<li><a href="http://www.jetbrains.com/idea/download/"><strong>IDEA</strong></a>，有两个版本：Ultimate Edition &amp; Community Edition，后者是free的，而且完全能满足学习者所有的需求  </li>
<li><a href="http://www.scala-lang.org/download/"><strong>Scala</strong></a>，Spark是用Scala语言写成的，在本地编译执行需要这个包</li>
<li><a href="http://www.scala-sbt.org/download.html"><strong>SBT</strong></a>，scala工程构建的工具</li>
<li><a href="http://git-scm.com/download/"><strong>Git</strong></a>，IDEA自动下载SBT插件时可能会用到的工具</li>
<li><a href="http://spark.apache.org/downloads.html"><strong>Spark Source Code</strong></a>，Spark源码</li>
</ul>
<p>下载各个安装包。</p>
<h2>Spark源码阅读环境的安装步骤</h2>
<h4>安装<a href="http://www.scala-lang.org/download/">Scala</a>。</h4>
<p>完成后，在windows命令行中输入<code>scala</code>，检查是否识别此命令。<br />
如果不识别，查看环境变量Path中是否有<code>....\scala\bin</code>（我的电脑右键，属性 -&gt; 高级系统设置 -&gt; 环境变量）,没有的手动将Scala文件夹下的bin目录的路径</p>
<h4>安装<a href="http://www.scala-sbt.org/download.html">SBT ...</a></h4> <a class="btn btn-info xsmall" href="http://www.guozhongxin.com/pages/2014/10/15/spark_source_code.html">read more</a></div>
    </div>	
				

 
        

 

    <div class='article'>
        <a href="http://www.guozhongxin.com/pages/2014/09/26/spark_installation.html"><h2>Spark安装：Spark集群及开发环境搭建</h2></a>
        <div class= "well small"> 2014-09-26

by <a class="url fn" href="http://www.guozhongxin.com/author/guozhongxin.html">guozhongxin</a>
 


 </div>
        <div class="summary"><p>一步一步在集群上安装spark，搭建spark上运行作业的开发环境</p> <a class="btn btn-info xsmall" href="http://www.guozhongxin.com/pages/2014/09/26/spark_installation.html">read more</a></div>
    </div>	
				
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="http://www.guozhongxin.com/category/spark.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="http://www.guozhongxin.com/archives.html">Archives</a>
                <li><a href="http://www.guozhongxin.com/tags.html">Tags</a>
                <li><a href="http://www.guozhongxin.com/" rel="alternate">Atom feed</a></li>
                <li><a href="http://www.guozhongxin.com/feeds/all.rss.xml" rel="alternate">RSS feed</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="http://www.guozhongxin.com/category/.html"></a></li>
                <li><a href="http://www.guozhongxin.com/category/blockchain.html">blockchain</a></li>
                <li><a href="http://www.guozhongxin.com/category/ganglia.html">ganglia</a></li>
                <li><a href="http://www.guozhongxin.com/category/python.html">Python</a></li>
                <li><a href="http://www.guozhongxin.com/category/spark.html">Spark</a></li>
                <li><a href="http://www.guozhongxin.com/category/summary.html">summary</a></li>
                   
            </ul>
            </div>

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Tags
                </li>

                <li><a href="http://www.guozhongxin.com/tag/.html"></a></li>
                <li><a href="http://www.guozhongxin.com/tag/pelican.html">pelican</a></li>
                <li><a href="http://www.guozhongxin.com/tag/python.html">python</a></li>
                <li><a href="http://www.guozhongxin.com/tag/yuan-ma.html">源码</a></li>
                <li><a href="http://www.guozhongxin.com/tag/source-code.html">source code</a></li>
                <li><a href="http://www.guozhongxin.com/tag/kai-fa-huan-jing.html">开发环境</a></li>
                <li><a href="http://www.guozhongxin.com/tag/spark.html">spark</a></li>
                <li><a href="http://www.guozhongxin.com/tag/ganglia.html">ganglia</a></li>
            </ul>
            </div>

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://getpelican.com/">Pelican</a></li>
                <li><a href="http://python.org/">Python</a></li>
                <li><a href="http://spark.apache.org/">Spark</a></li>
            </ul>
            </div>

            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="http://www.linkedin.com/profile/view?id=317695648"> Linkedin</a></li>
                <li><a href="https://github.com/guozhongxin"> Github</a></li>
                <li><a href="http://weibo.com/u/1832109601"> Weibo</a></li>
                <li><a href="mailto:buptmr.guo@gmail.com"> E-mail</a></li>
            </ul>
            </div>
            </div>

        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="http://www.guozhongxin.com">guozhongxin's blog</a> &copy; guozhongxin <img src="http://www.guozhongxin.com/theme/images/icons/smile.png">  2014-2017</p>
</footer>

</div> <!-- /container -->
<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js"></script> -->

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"slide":{"type":"slide","bdImg":"1","bdPos":"right","bdTop":"100"},"image":{"viewList":["tsina","weixin","evernotecn","linkedin","renren"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","weixin","evernotecn","linkedin","renren"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

<script>var _gaq=[['_setAccount','UA-55010568-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>
<a href="https://github.com/guozhongxin"><img style="position: absolute; top: 40px; right: 0; border: 0;" src="http://www.guozhongxin.com/theme/images/icons/forkme_right_white.png" alt="Fork me on GitHub" /></a>
 

</body>
</html>